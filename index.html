<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Note Pro ğŸ’</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            margin: 0;
            height: 100vh;
            box-sizing: border-box;
            overflow-y: auto; /* Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ú©Ù„ ØµÙØ­Ù‡ */
        }

        /* Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± Ø¨Ø§Ù„Ø§ */
        .toolbar {
            width: 100%;
            max-width: 900px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="password"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 13px;
            width: 150px;
        }

        /* Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø³Ø§ÛŒØ² Ù‚Ù„Ù… */
        input[type="range"] {
            width: 100px;
        }
        
        label { font-size: 12px; color: #555; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¨Ø²Ø§Ø± */
        .tool-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .tool-btn.active {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1565c0;
        }

        /* Ø¨ÙˆÙ… Ù†Ù‚Ø§Ø´ÛŒ Ø¨Ø²Ø±Ú¯ */
        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 60vh; /* 60 Ø¯Ø±ØµØ¯ Ø§Ø±ØªÙØ§Ø¹ ØµÙØ­Ù‡ */
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            touch-action: none; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ù‡Ù†Ú¯Ø§Ù… Ù†ÙˆØ´ØªÙ† */
            border: 2px solid #ccc;
            margin-bottom: 15px;
            cursor: crosshair;
        }

        canvas { width: 100%; height: 100%; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª Ø§ØµÙ„ÛŒ */
        .main-controls {
            display: flex;
            gap: 10px;
            width: 100%;
            max-width: 900px;
            margin-bottom: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            color: white;
        }

        .btn-extract { background-color: #673ab7; }
        .btn-process { background-color: #009688; display: none; }
        .btn-clear-all { background-color: #ff5252; flex: 0 0 auto; }

        /* Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ */
        .results-area {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 50px;
        }

        .card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        .card h4 {
            margin: 0 0 10px 0;
            font-size: 12px;
            color: #666;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .content {
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            direction: ltr; 
            text-align: left;
        }

        /* Ù‡Ø§ÛŒÙ„Ø§ÛŒØªâ€ŒÙ‡Ø§ */
        .highlight-change {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-bottom: 2px solid #2e7d32;
            font-weight: bold;
            padding: 0 2px;
        }

        .loading { color: #888; font-style: italic; }
        .error-msg { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 6px; font-size: 12px; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="tool-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        
        <div class="tool-group">
            <label>Ø³Ø§ÛŒØ²:</label>
            <input type="range" id="penSize" min="1" max="10" value="3">
            
            <button class="tool-btn active" id="btnPen" onclick="setTool('pen')">âœï¸ Ù‚Ù„Ù…</button>
            <button class="tool-btn" id="btnEraser" onclick="setTool('eraser')">ğŸ§¹ Ù¾Ø§Ú©â€ŒÚ©Ù†</button>
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="noteCanvas"></canvas>
    </div>

    <div class="main-controls">
        <button class="action-btn btn-clear-all" onclick="clearAll()">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ù„ ØµÙØ­Ù‡ ğŸ—‘ï¸</button>
        <button class="action-btn btn-extract" onclick="extractText()">1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† (Extract)</button>
        <button class="action-btn btn-process" id="processBtn" onclick="processGrammar()">2. ØªØ±Ø¬Ù…Ù‡ Ùˆ Ø§ØµÙ„Ø§Ø­ (Correct)</button>
    </div>

    <div class="results-area">
        <div class="card" id="rawCard" style="display:none;">
            <h4>Raw Extracted Text</h4>
            <div id="rawContent" class="content"></div>
        </div>

        <div class="card" id="diffCard" style="display:none;">
            <h4>Grammar Correction & Diff</h4>
            <div style="margin-bottom: 15px;">
                <span style="font-size:12px; color:#888;">Literal Translation:</span>
                <div id="literalContent" class="content" style="color:#555; font-style:italic;"></div>
            </div>
            <div>
                <span style="font-size:12px; color:#2e7d32; font-weight:bold;">Final Corrected:</span>
                <div id="finalContent" class="content"></div>
            </div>
        </div>
    </div>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨ÙˆÙ… Ùˆ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ ---
        const canvas = document.getElementById('noteCanvas');
        const ctx = canvas.getContext('2d');
        const penSizeSlider = document.getElementById('penSize');
        
        let isDrawing = false;
        let currentTool = 'pen'; // 'pen' or 'eraser'

        // ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ø¨ÙˆÙ… Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù†Ø¯Ø§Ø²Ù‡ ØµÙØ­Ù‡
        function resizeCanvas() {
            const container = canvas.parentElement;
            // Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ¹Ù„ÛŒ Ù‚Ø¨Ù„ Ø§Ø² ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² (Ú†ÙˆÙ† ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ø¨ÙˆÙ… Ø±Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tempCtx.drawImage(canvas, 0, 0);

            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;

            // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù…Ø­ØªÙˆØ§
            ctx.drawImage(tempCanvas, 0, 0);
            
            updateContextSettings();
        }

        // Ø§Ø¹Ù…Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ù„Ù…/Ù¾Ø§Ú©â€ŒÚ©Ù†
        function updateContextSettings() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = penSizeSlider.value;
            
            if (currentTool === 'pen') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = '#000000';
            } else {
                ctx.globalCompositeOperation = 'destination-out'; // Ø­Ø§Ù„Øª Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
            }
        }

        window.addEventListener('resize', resizeCanvas);
        // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ù„ÙˆØ¯ CSS
        setTimeout(resizeCanvas, 100);

        // Ù„ÛŒØ³Ù†Ø± Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø³Ø§ÛŒØ² Ù‚Ù„Ù…
        penSizeSlider.addEventListener('input', updateContextSettings);

        function setTool(tool) {
            currentTool = tool;
            document.getElementById('btnPen').classList.toggle('active', tool === 'pen');
            document.getElementById('btnEraser').classList.toggle('active', tool === 'eraser');
            updateContextSettings();
        }

        // --- Ù…Ù†Ø·Ù‚ Ø±Ø³Ù… (Drawing Logic) ---
        function start(e) {
            isDrawing = true;
            draw(e);
        }
        function end() {
            isDrawing = false;
            ctx.beginPath();
        }
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', end);
        canvas.addEventListener('mouseout', end);
        
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e.touches[0]); }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); }, {passive: false});
        canvas.addEventListener('touchend', end);


        // --- Ù…Ù†Ø·Ù‚ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (AI Logic) ---
        const rawCard = document.getElementById('rawCard');
        const diffCard = document.getElementById('diffCard');
        const rawContent = document.getElementById('rawContent');
        const processBtn = document.getElementById('processBtn');

        function clearAll() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            rawCard.style.display = 'none';
            diffCard.style.display = 'none';
            processBtn.style.display = 'none';
            rawContent.innerText = "";
        }

        function getApiKey() {
            const key = document.getElementById('apiKey').value;
            if (!key) { alert("Ù„Ø·ÙØ§Ù‹ API Key Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!"); return null; }
            return key;
        }

        // ØªØ§Ø¨Ø¹ ØªÙ…ÛŒØ²Ú©Ù†Ù†Ø¯Ù‡ JSON Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ø§Ø±ÙˆØ±
        function cleanJsonText(text) {
            // Ø­Ø°Ù Ù…Ø§Ø±Ú©â€ŒØ¯Ø§ÙˆÙ† ```json Ùˆ ```
            return text.replace(/```json/g, '').replace(/```/g, '').trim();
        }

        async function extractText() {
            const key = getApiKey(); if (!key) return;

            rawCard.style.display = 'block';
            rawContent.innerHTML = '<span class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø³ØªØ®Ø·...</span>';
            
            const imageData = canvas.toDataURL('image/png').split(',')[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: "Extract the handwritten text exactly as is (mixed Persian/English). Do not translate." },
                        { inlineData: { mimeType: "image/png", data: imageData } }
                    ]
                }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                
                const text = data.candidates[0].content.parts[0].text;
                rawContent.innerText = text;
                processBtn.style.display = 'block';

            } catch (e) {
                rawContent.innerHTML = `<div class="error-msg">Error: ${e.message}</div>`;
            }
        }

        async function processGrammar() {
            const key = getApiKey();
            const text = rawContent.innerText;
            
            diffCard.style.display = 'block';
            document.getElementById('literalContent').innerHTML = '<span class="loading">...</span>';
            document.getElementById('finalContent').innerHTML = '<span class="loading">Processing...</span>';
            diffCard.scrollIntoView({behavior: 'smooth'});

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;

            const prompt = `
            Act as a strict JSON generator.
            Input Text: "${text}"
            
            Task:
            1. Translate any Persian words to English literally (word-for-word).
            2. Correct the grammar to be simple and clear English.
            3. Compare the literal translation with the corrected version. Wrap ANY word in the corrected version that was changed, added, or moved in <span class='highlight-change'> tags.
            
            Output strictly valid JSON with this structure (NO Markdown, NO backticks):
            {
                "literal": "Literal translation string",
                "diff_html": "Corrected string with HTML tags"
            }
            `;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                let rawResponseText = data.candidates[0].content.parts[0].text;
                // ØªÙ…ÛŒØ²Ú©Ø§Ø±ÛŒ Ù…ØªÙ† Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ Ù¾Ø§Ø±Ø³
                rawResponseText = cleanJsonText(rawResponseText);

                const jsonResult = JSON.parse(rawResponseText);

                document.getElementById('literalContent').innerText = jsonResult.literal;
                document.getElementById('finalContent').innerHTML = jsonResult.diff_html;

            } catch (e) {
                console.error(e);
                document.getElementById('finalContent').innerHTML = `<div class="error-msg">Error parsing: ${e.message}. Try again.</div>`;
            }
        }
    </script>
</body>
</html>
