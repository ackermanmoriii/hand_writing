<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Smooth AI Note ğŸ</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: #f2f2f7; /* Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¢ÛŒÙ¾Ø¯ */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            margin: 0;
            height: 100vh;
            box-sizing: border-box;
            overflow-y: auto;
        }

        /* Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± */
        .toolbar {
            width: 100%;
            max-width: 900px;
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            background: white;
            padding: 12px 16px;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            flex-wrap: wrap;
        }

        .tool-group { display: flex; align-items: center; gap: 10px; }

        input[type="password"] {
            padding: 10px; border: 1px solid #d1d1d6; border-radius: 8px;
            font-size: 14px; width: 140px; text-align: left; direction: ltr; outline: none;
            background: #f9f9f9;
        }
        input[type="password"]:focus { border-color: #007aff; background: #fff; }

        label { font-size: 13px; color: #333; font-weight: 500; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¨Ø²Ø§Ø± */
        .tool-btn {
            padding: 8px 16px; border: none; background: #f2f2f7;
            border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500;
            color: #333; transition: all 0.2s ease;
        }
        .tool-btn.active { background: #007aff; color: white; box-shadow: 0 2px 8px rgba(0,122,255,0.3); }

        /* Ø¨ÙˆÙ… Ù†Ù‚Ø§Ø´ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ */
        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 60vh;
            background: white;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); /* Ø³Ø§ÛŒÙ‡ Ù†Ø±Ù…â€ŒØªØ± */
            overflow: hidden;
            touch-action: none; /* Ø­ÛŒØ§ØªÛŒ */
            margin-bottom: 20px;
            cursor: crosshair;
        }

        canvas { width: 100%; height: 100%; display: block; }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒØ§Øª */
        .main-controls {
            display: flex; gap: 12px; width: 100%; max-width: 900px; margin-bottom: 30px;
        }
        .action-btn {
            flex: 1; padding: 14px; border: none; border-radius: 12px;
            font-weight: 600; font-size: 15px; cursor: pointer; color: white;
            transition: transform 0.1s, opacity 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .action-btn:active { transform: scale(0.98); }
        .btn-extract { background-color: #5856d6; /* Ø±Ù†Ú¯ Ø¨Ù†ÙØ´ iOS */ }
        .btn-process { background-color: #34c759; /* Ø±Ù†Ú¯ Ø³Ø¨Ø² iOS */ display: none; }
        .btn-clear-all { background-color: #ff3b30; flex: 0 0 auto; color: white; }

        /* Ù†ØªØ§ÛŒØ¬ */
        .results-area { width: 100%; max-width: 900px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 60px; }
        .card { background: white; padding: 20px; border-radius: 14px; border: 1px solid #e5e5ea; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .card h4 { margin: 0 0 12px 0; font-size: 13px; color: #8e8e93; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #f2f2f7; padding-bottom: 8px; }
        .content { font-size: 17px; line-height: 1.6; color: #1c1c1e; white-space: pre-wrap; direction: ltr; text-align: left; }
        
        .highlight-change { background-color: #dcfce7; color: #166534; padding: 2px 4px; border-radius: 4px; font-weight: 600; }
        .loading { color: #8e8e93; font-style: italic; }
        .error-msg { color: #ff3b30; background: #fff2f1; padding: 12px; border-radius: 8px; font-size: 13px; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div class="tool-group">
            <input type="password" id="apiKey" placeholder="Gemini API Key">
        </div>
        <div class="tool-group">
            <button class="tool-btn active" id="btnPen" onclick="setTool('pen')">Pen âœ’ï¸</button>
            <button class="tool-btn" id="btnEraser" onclick="setTool('eraser')">Eraser ğŸ§¹</button>
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="noteCanvas"></canvas>
    </div>

    <div class="main-controls">
        <button class="action-btn btn-clear-all" onclick="clearAll()">Clear</button>
        <button class="action-btn btn-extract" onclick="extractText()">Extract Text</button>
        <button class="action-btn btn-process" id="processBtn" onclick="processGrammar()">Correct Grammar</button>
    </div>

    <div class="results-area">
        <div class="card" id="rawCard" style="display:none;">
            <h4>Raw Text</h4>
            <div id="rawContent" class="content" style="font-family: 'Menlo', monospace;"></div>
        </div>

        <div class="card" id="diffCard" style="display:none;">
            <h4>Smart Correction</h4>
            <div style="margin-bottom: 15px;">
                <span style="font-size:12px; color:#8e8e93;">Literal Translation:</span>
                <div id="literalContent" class="content" style="color:#666; font-style:italic;"></div>
            </div>
            <div>
                <span style="font-size:12px; color:#34c759; font-weight:bold;">Final Polish:</span>
                <div id="finalContent" class="content"></div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('noteCanvas');
        const ctx = canvas.getContext('2d');
        
        let isDrawing = false;
        let currentTool = 'pen';
        let points = []; // Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‚Ø§Ø· Ø¬Ù‡Øª Ù†Ø±Ù…â€ŒØ³Ø§Ø²ÛŒ Ø®Ø·

        // --- 1. ØªÙ†Ø¸ÛŒÙ…Ø§Øª High DPI (Retina) ---
        function resizeCanvas() {
            const container = canvas.parentElement;
            const rect = container.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù…Ø­ØªÙˆØ§
            let tempCanvas = null;
            if (canvas.width > 0) {
                tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                tempCanvas.getContext('2d').drawImage(canvas, 0, 0);
            }

            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            
            ctx.scale(dpr, dpr);
            
            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø­ØªÙˆØ§
            if (tempCanvas) {
                ctx.drawImage(tempCanvas, 0, 0, tempCanvas.width / dpr, tempCanvas.height / dpr);
            }
            
            // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡ Ù‚Ù„Ù…
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            // Ø±Ù†Ú¯ Ù…Ø´Ú©ÛŒ Ø¬ÙˆÙ‡Ø±ÛŒ (Ú©Ù…ÛŒ Ù…Ù„Ø§ÛŒÙ…â€ŒØªØ± Ø§Ø² Ù…Ø´Ú©ÛŒ Ø®Ø§Ù„Øµ)
            ctx.strokeStyle = '#1c1c1e'; 
        }

        window.addEventListener('resize', () => setTimeout(resizeCanvas, 100));
        setTimeout(resizeCanvas, 100);

        function setTool(tool) {
            currentTool = tool;
            document.getElementById('btnPen').classList.toggle('active', tool === 'pen');
            document.getElementById('btnEraser').classList.toggle('active', tool === 'eraser');
        }

        // --- 2. Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ù†Ù‚Ø§Ø´ÛŒ Ù†Ø±Ù… (Smooth Drawing) ---
        
        // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÙØ´Ø§Ø± Ù‚Ù„Ù… Ø±Ø§ Ø¨Ù‡ Ø¶Ø®Ø§Ù…Øª Ø®Ø· ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
        function getLineWidth(pressure) {
            if (currentTool === 'eraser') return 25;
            // Ø§Ú¯Ø± Ù‚Ù„Ù… ÙØ´Ø§Ø± Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ú©Ù†Ø¯ (Ù…Ø«Ù„ Ù…Ø§ÙˆØ³)ØŒ ÙØ´Ø§Ø± 0.5 Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            const p = (pressure !== undefined && pressure > 0) ? pressure : 0.5;
            // Ø¶Ø®Ø§Ù…Øª Ø¨ÛŒÙ† 2 ØªØ§ 6 Ù¾ÛŒÚ©Ø³Ù„ Ù…ØªØºÛŒØ± Ø§Ø³Øª
            return 2 + (p * 4); 
        }

        function start(e) {
            isDrawing = true;
            points = []; // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù†Ù‚Ø§Ø·
            
            const rect = canvas.getBoundingClientRect();
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Pointer Events Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙØ´Ø§Ø± Ù‚Ù„Ù…
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const pressure = e.pressure;

            points.push({ x, y, pressure });
            
            ctx.beginPath();
            ctx.moveTo(x, y);
            
            // Ù†Ù‚Ø·Ù‡ Ø´Ø±ÙˆØ¹ Ø±Ø§ Ú©Ù…ÛŒ Ù¾Ø±Ø±Ù†Ú¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ù…Ø«Ù„ Ú¯Ø°Ø§Ø´ØªÙ† Ù†ÙˆÚ© Ù‚Ù„Ù… Ø±ÙˆÛŒ Ú©Ø§ØºØ°)
            ctx.lineWidth = getLineWidth(pressure);
            ctx.lineTo(x, y); 
            ctx.stroke();
        }

        function move(e) {
            if (!isDrawing) return;
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ ÙÙ‚Ø· Ø§Ú¯Ø± Ù‚Ù„Ù… Ø±ÙˆÛŒ Ø¨ÙˆÙ… Ø§Ø³Øª
            if(e.cancelable) e.preventDefault(); 

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const pressure = e.pressure;

            points.push({ x, y, pressure });

            // ØªÚ©Ù†ÛŒÚ© Quadratic Curve:
            // Ø¨Ø±Ø§ÛŒ Ø±Ø³Ù… Ø®Ø· Ù†Ø±Ù…ØŒ Ù…Ø§ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ù‡ Ù†Ù‚Ø·Ù‡ Ø¬Ø¯ÛŒØ¯ ÙˆØµÙ„ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
            // Ø¨Ù„Ú©Ù‡ Ø¨Ù‡ "Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†" Ù†Ù‚Ø·Ù‡ Ù‚Ø¨Ù„ÛŒ Ùˆ ÙØ¹Ù„ÛŒ ÙˆØµÙ„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
            if (points.length > 2) {
                const lastPoint = points[points.length - 2];
                const currentPoint = points[points.length - 1];
                
                // Ù†Ù‚Ø·Ù‡ Ú©Ù†ØªØ±Ù„ Ø¨Ø±Ø§ÛŒ Ù…Ù†Ø­Ù†ÛŒ (Ù†Ù‚Ø·Ù‡ Ù‚Ø¨Ù„ÛŒ)
                const xc = (lastPoint.x + currentPoint.x) / 2;
                const yc = (lastPoint.y + currentPoint.y) / 2;

                // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø¨Ø²Ø§Ø±
                if (currentTool === 'pen') {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = '#1c1c1e';
                } else {
                    ctx.globalCompositeOperation = 'destination-out';
                }

                ctx.lineWidth = getLineWidth(currentPoint.pressure);
                
                // Ø±Ø³Ù… Ù…Ù†Ø­Ù†ÛŒ
                ctx.quadraticCurveTo(lastPoint.x, lastPoint.y, xc, yc);
                ctx.stroke();
                
                // Ø´Ø±ÙˆØ¹ Ù…Ø³ÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ù†Ù‚Ø·Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ù…Ø§Ù†Ø¯ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ù†Ø±Ù…
                ctx.beginPath();
                ctx.moveTo(xc, yc);
            }
        }

        function end() {
            isDrawing = false;
            points = [];
            ctx.beginPath(); // Ø¨Ø³ØªÙ† Ù…Ø³ÛŒØ±
        }

        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Pointer Events (Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¬Ø¯ÛŒØ¯ Ú©Ù‡ Pen/Touch/Mouse Ø±Ø§ Ù¾ÙˆØ´Ø´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯)
        canvas.addEventListener('pointerdown', start);
        canvas.addEventListener('pointermove', move);
        canvas.addEventListener('pointerup', end);
        canvas.addEventListener('pointerout', end);

        // --- AI Logic (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¯Ø± Ù…Ù†Ø·Ù‚ØŒ ÙÙ‚Ø· Ø­ÙØ¸ Ø¹Ù…Ù„Ú©Ø±Ø¯) ---
        const rawContent = document.getElementById('rawContent');
        const processBtn = document.getElementById('processBtn');

        function clearAll() {
            const dpr = window.devicePixelRatio || 1;
            ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
            document.getElementById('rawCard').style.display = 'none';
            document.getElementById('diffCard').style.display = 'none';
            processBtn.style.display = 'none';
            rawContent.innerText = "";
        }

        function cleanJsonText(text) { return text.replace(/```json/g, '').replace(/```/g, '').trim(); }
        function getApiKey() { 
            const k = document.getElementById('apiKey').value; 
            if(!k) alert("Please enter API Key"); 
            return k; 
        }

        async function extractText() {
            const key = getApiKey(); if (!key) return;
            document.getElementById('rawCard').style.display = 'block';
            rawContent.innerHTML = '<span class="loading">Scanning...</span>';
            
            const imageData = canvas.toDataURL('image/png').split(',')[1];
            // Ù¾Ø±Ø§Ù…Ù¾Øª Ø³Ø®Øªâ€ŒÚ¯ÛŒØ±Ø§Ù†Ù‡ Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„
            const payload = {
                contents: [{ parts: [
                    { text: "Strict OCR mode. Extract mixed Persian/English text exactly as written. No hallucination. No extra words." },
                    { inlineData: { mimeType: "image/png", data: imageData } }
                ]}],
                generationConfig: { temperature: 0.0 } // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ù„Ø§Ù‚ÛŒØª
            };

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
                });
                const data = await res.json();
                rawContent.innerText = data.candidates[0].content.parts[0].text;
                processBtn.style.display = 'block';
            } catch (e) { rawContent.innerText = "Error: " + e.message; }
        }

        async function processGrammar() {
            const key = getApiKey();
            document.getElementById('diffCard').style.display = 'block';
            document.getElementById('finalContent').innerHTML = '<span class="loading">Thinking...</span>';
            
            const prompt = `
            Act as a JSON generator. Input: "${rawContent.innerText}"
            1. "literal": Translate Persian to English literally.
            2. "diff_html": Correct grammar naturally. Wrap CHANGED words in <span class='highlight-change'> tags.
            Output JSON: { "literal": "...", "diff_html": "..." }
            `;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const json = JSON.parse(cleanJsonText(data.candidates[0].content.parts[0].text));
                document.getElementById('literalContent').innerText = json.literal;
                document.getElementById('finalContent').innerHTML = json.diff_html;
            } catch (e) { document.getElementById('finalContent').innerText = "Error."; }
        }
    </script>
</body>
</html>
